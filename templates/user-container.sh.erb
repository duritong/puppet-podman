#!/bin/bash

function pod_stop() {
  running_id=$(/usr/bin/podman ps --format '{{.ID}} {{.Names}}' --filter 'name=<%= @sanitised_title %>' --filter 'status=running' | /usr/bin/grep -E ' <%= @sanitised_title %>$' | cut -d' ' -f 1)
  if [ ! -z $running_id ]; then
    echo "Stopping Container <%= @sanitised_title %> - ${running_id}"
    /usr/bin/podman stop -t 20 "${running_id}"
    running_id=$(/usr/bin/podman ps --format '{{.ID}} {{.Names}}' --filter 'name=<%= @sanitised_title %>' --filter 'status=running' | /usr/bin/grep -E ' <%= @sanitised_title %>$' | cut -d' ' -f 1)
    if [ ! -z $running_id ]; then
      /usr/bin/podman kill $running_id > /dev/null
      if [ $? -gt 0 ]; then
        echo "Error while killing running container!"
        exit 120
      fi
    fi
  fi
}

function pod_start() {
<% if @pull_image_before_start -%>
  echo "Prepulling image for <%= @sanitised_title %>"
  /usr/bin/podman pull <%= @image %>
<% end -%>
  container_id=$(/usr/bin/podman ps -a --format '{{.ID}} {{.Names}}' --filter 'name=<%= @sanitised_title %>' | /usr/bin/grep -E ' <%= @sanitised_title %>$' | cut -d' ' -f 1)
  if [ ! -z $container_id ]; then
    echo "Container  <%= @sanitised_title %> - ${container_id} still present. Removing..."
    /usr/bin/podman rm $container_id > /dev/null
    if [ $? -gt 0 ]; then
      # maybe it's gone
      container_id=$(/usr/bin/podman ps -a --format '{{.ID}} {{.Names}}' --filter 'name=<%= @sanitised_title %>' | /usr/bin/grep -E ' <%= @sanitised_title %>$' | cut -d' ' -f 1)
      if [ ! -z $container_id ]; then
        echo "Error while removing existing container!"
        exit 120
      fi
    fi
  fi
  echo "Starting Container <%= @sanitised_title %>"
  /usr/bin/podman run --name <%= @sanitised_title %> \
<% Array(@publish).each do |p| -%>
    --publish <%= p %> \
<% end -%>
<% Hash(@volumes).each do |host_dir,container_dir| -%>
    --volume <%= "#{host_dir}:#{container_dir}" %> \
<% end -%>
<% if @run_flags['user'] -%>
    --user=<%= @run_flags['user'] %> \
<% end -%>
<% if @run_flags['userns'] -%>
    --userns=<%= @run_flags['userns'] %> \
<% end -%>
<% if @run_flags['security-opt-label-type'] -%>
    --security-opt=label=type:<%= @run_flags['security-opt-label-type'] %>.process \
<% end -%>
    <%= @image %> \
    <% if @command %> <%= @command %><% end %>
}

if [ "$1" == 'stop' ]; then
  pod_stop
elif [ "$1" == 'start' ]; then
  pod_stop
  pod_start
else
  echo "USAGE: $0 (start|stop)"
  exit 128
fi
